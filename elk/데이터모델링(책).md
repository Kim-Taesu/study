#### 매핑

- 색인 시 데이터가 어디에 어떻게 저장될지를 결정한느 설정
- 인덱스에 추가되는 각 데이터 타입을 구체적으로 정의하는 일
- 문서에 존재하는 필드의 속성을 정의할 때 각 필드 속성에는 데이터 타입과 메타데이터가 포함된다.
- 엘라스틱서치는 기본적으로 스키마리스이기 때문에 명시적으로 필드를 정의하지 않아도 데이터 유형에 따라 필드 데이터 타입에 대한 매핑 정보가 자동으로 생성된다.
- 한번 생성된 매핑의 타입은 변경할 수 없다.
  - 인덱스를 삭제한 후 다시 생성
  - 매핑을 다시 정의
- 매핑 정보 설정
  - 문자열 분석할 것인지
  - _source에 어떤 필드를 정의할 것인지
  - 날짜 필드를 가지느 필드는 무엇인지
  - 매핑에 정의되지 않고 유입되는 필드는 어떻게 처리할 것인지



#### Fielddata

- 엘라스틱서치가 힙 공간에 생성하는 메모리 캐시
- 현재는 doc_values의  새로운 형태의 캐시 제공
- text 타입의 필드는 기본적으로 분석기에 의해 형태소 분석이 되기 때문에 집계나 정렬 등의 기능을 수행할 수 없다.
  - 집계나 정렬을 수행하는 경우 fielddata를 사용



#### doc_values

- 엘라스틱서치에서 사용하는 기본 캐시
- text 타입을 제외한 모든 타입에서 기본적으로 doc_values 캐시를 사용





#### dynamic

- 매핑에 필드를 추가할 때 동적으로 생성할지, 생성하지 않을지를 결정
  - true : 새로 추가되는 필드를 매핑에 추가한다.
  - false : 새로 추가되는 필드를 무시
  - strict : 새로운 필드가 감지되면 예외가 발생하고 문서 자체가 색인되지 않는다.



#### Enabled

- false로 설정하면 _source에는 검색이 되지만 색인은 하지 않는다.



#### format

- 엘라스틱서치는 날짜/시간을 문자열로 표시



#### ignore_above

- 필드에 저장되는 문자열이 지정한 크기를 넘어서면 빈 값으로 색인
- 지정된 크기만큼 색인되는 것이 아닌 빈 값으로 저장



#### ignore_malformed

- 잘못된 데이터 데이터 타입을 색인하려고 할 때 해당 필드만 무시하고 문서는 색인할 수 있다.



#### index

- 필드값을 색인할지를 결정
- 기본값은 true



#### fields

- 다중 필드를 설정
- 필드 안에 또 다른 필드를 설정할 수 있다.



#### null_value

- null_value를 설정하여 문서의 값이 null 이더라도 설정한 값으로 필드 생성



#### position_increment_gap

- 배열 형태의 데이터를 색인할 때 검색의 정확도를 높이기 위해 제공하는 옵션





#### 메타 필드

- 엘라스틱서치에서 생성한 문서에서 제공하는 특별한 필드
- 메타데이터를 저장하는 특수 목적의 필드



#### _idedx 메타 필드

- 해당 문서가 속한 인덱스의 이름을 담고 있다.



#### _type 메타 필드

- 해당 문서가 속한 매핑의 타입 정보를 담고 있다.



#### _id 메타 필드

- 문서를 식별하는 유일한 키 값
- 한 인덱스에서 색인된 문서마다 서로 다른 키 값을 가진다.



#### _uid 메타 필드

- 특수한 목적의 식별키
- "#" 태그를 사용해 _type과 _id 값을 조합해 사용한다.



#### _source 메타 필드

- 문서의 원본 데이터를 제공
- 내부에는 색인 시 전달된 원본 JSON 문서의 본문이 저장돼 있다.



#### _rounting 메타 필드

- 특정 문서를 특정 샤드에 저장하기 위해 사용자가 지정하는 메타 필드
- _routing 값이 샤드를 결정하는 데 사용



#### 필드 데이터 타입

- 문자열 데이터 타입
  - keyword, text
- 일반적인 데이터 타입
  - date, long, double, integer, boolean, ip
- 객체 또는 중첩문과 같은 JSON 계층의 특성의 데이터 타입
- geo_point, geo_shape 같은 특수한 데이터타입



#### keyword 데이터 타입

- 별도의 분석기를 거치지 않고 원문 그대로 색인하기 때문에 특정 코드나 키워드 등 정형화된 콘텐츠에 주로 사용
- 검색 시 필터링되는 항목
- 정렬이 필요한 항목
- Aggregation 해야 하는 항목
- 주요 파라미터
  - boost : 필드의 가중치로, 검색 결과 정렬에 영향을 준다.
  - doc_values : 필드를 메모리에 로드해 캐시로 사용 (기본값 true)
  - index : 해당 필드를 검색에 사용할지를 설정 (기본값 true)
  - null_value : 데이터의 값이 없는 경우 null로 필드의 값을 대체할지를 설정
  - store : 필드 값을 필드와 별도로 _source에 저장하고 검색 가능하게 할지를 설정 (기본값 false)



#### Text 데이터 타입

- 색인 시 지정된 분석기가 칼럼의 데이터를 문자열 데이터로 인식하고 이를 분석한다.
- 별도의 분석기를 정의하지 않았다면 기본적으로 Standard Analyzer 사용
- 문장 형태의 데이터에 사용하기 적합한 데이터 타입
- 전문 검색이 가능하다.
  - 전체 텍스트가 토큰화되어 생성되며 특정 단어를 검색하는 것이 가능



#### Array 데이터 타입

- 객체 형태로도 정의할 수 있다.
- Array 타입에 저장되는 값은 모두 같은 타입으로만 구성해야 한다.



#### 분석기의 구조

- 프로세스 동작
  - 문장을 특정한 규칙에 의해 수정
  - 수정한 문장을 개별 토큰으로 분리
  - 개별 토큰을 특정한 규칙에 의해 변경
- 용어
  - Character Filter
    - 텍스트를 개별 토큰화하기 전의 전처리 과정
    - 패턴으로 텍스트를 변경하거나 사용자가 정의한 필터를 적용
  - Tokenizer Filter
    - 분석기를 구성할 때 하나만 사용
    - 텍스트를 어떻게 나눌 것인지를 정의
  - Token Filter
    - 토큰화된 단어를 하나씩 필터링해서 사용자가 원하는 토큰으로 변환



#### 대표적인 Document API

- Index API : 문서를 생성
- Get API : 문서를 조회
- Delete API : 문서를 삭제
- Update API : 문서를 수정
- Bulk API : 대량의 문서를 처리
- Reindex API : 문서를 복사



#### 문서 파라미터

- 문서 ID 자동 생성
  - id 값을 지정하지 않으면 UUID 값이 자동으로 추가된다.



#### INDEX API

- 새로 추가된 문서는 버전 값으로 1이 부여
- 문서가 업데이트 될 때마다 버전이 1 증가한다.
- _shard
  - 몇 개의 샤드에서 명령이 수행됐는지에 대한 정보를 나타낸다.
  - total : 복제 돼야 하는 전체 샤드 개수
  - successful : 성공적으로 복제된 샤드 개수
  - failed : 복제에 실패한 샤드 건수
- 최소 1개의 successful 항목이 있어야 성공한 것으로 간주



#### Get API

- 특정 문서를 인덱스에서 조회할 때 사용하는 APU
- 조회하고자 하는 문서의 ID를 명시적으로 지정해서 사용
- 일반적으로 조회되는 문서의 내용은 _source 항목으로 확인할 수 있다.

- ```
  GET {index}/{type}/{id}
  ```

- _source_esclude 옵션을 이용해 제외할 필드명을 지정할 수 있다.



#### Delete API

- ```
  DELETE {index}/{type}/{id}
  ```

- 결과로 "deleted" 반환되며, _version 값이 1 증가한다.

- 인덱스 삭제

  - ```
    DELETE {index}
    ```



#### Delete By Query API

- ```
  POST {index}/_delete_by_query
  {
  	"query":{
  		"term":{
  			{field}:{value}
  		}
  	}
  
  }
  ```



#### Update API

- 스크립트를 바탕으로 문서를 수정

- 스크립트를 통해 "ctx._source.필드명"과 같은 형태로 접근

- Update API가 호출되면 엘라스틱서치는 Index에서 문서를 가져와 스크립트를 수행한 후, 이를 다시 재색인 한다.

- _source 필드가 활성화돼 있어야 한다.

- ctx 필드에서 이용가능한 변수

  - _source
  - _type
  - _id
  - _version
  - _routing
  - _now

  ```
  POST {index}/{type}/_update
  {
  	"script":{
  		"source":"ctx._source.{field} 처리할 명령"
  		"lang":"painless"
  		"params":{
  			"count":1
  		}
  	}
  }
  ```



#### BULK API

- 한 번의 API 호출로 다수의 문서를 색인하거나 삭제할 수 있다.

- ```
  # 대량 색인
  POST _bulk
  {"index":{"_index":"", "_type":"", "_id":""}}
  {"title":""}
  
  {"index":{"_index":"", "_type":"", "_id":""}}
  {"title":""}
  
  {"index":{"_index":"", "_type":"", "_id":""}}
  {"title":""}
  
  # 여러가지 작업 수행 가능
  POST _bulk
  {"index":{"_index":"", "_type":"", "_id":""}}
  {"title":""}
  
  {"delete":{"_index":"", "_type":"", "_id":""}}
  
  {"update":{"_index":"", "_type":"", "_id":""}}
  {"doc":{"field":"value"}}
  ```



#### Reindex API

- 한 인덱스에서 다른 인덱스로 문서를 복사할 때 사용

- ```
  POST /_reindex
  {
  	"source":{
  		"index":"{source index}",
  		"type":"_doc",
  		"query":{
  			"term":{
  				...
  			}
  		}
  	},
  	"dest":{
  		"index":"{dest index}"
  	}
  }
  ```

